# 计时器使用说明

## 一、基本使用方法

计时器需要和CPU一起reset，在reset进行初始化后，计时器处于待机状态，之后由用户对其进行操作。

操作方法：

* 用户通过sw指令向相应计时器的初值寄存器写入计数初值；
* 用户设定控制寄存器的IM位、Mode位、Enable位后，将设定好的变量通过sw指令写入控制寄存器；
* 计时器在时钟上升沿检测到Enable信号有效，根据用户设定的Mode开始相应计数过程。
* 计数结束后计时器根据IM位状态产生中断交CPU处理。

## 二、具体可行操作

### 1、计时器待机状态下

* 允许对初值寄存器按整字读取或写入数据。
  * 写入数据后将在激活计数器时作为计数初值。
* 允许对控制寄存器按整字读取或写入数据。
  * 写入IM、Mode位的数据不影响计时器当前待机状态。
  * 写入Enable数据若为1，则启动计数功能。
* 允许对计数值寄存器按整字读取数据。

### 2、计时器计数中

* 允许对初值寄存器按整字读取或写入数据
  * 写入数据后将从下一次计数周期开始应用写入的初值。
* 允许对控制寄存器按整字读取数据
* 允许对计数值寄存器按整字读取数据
* 对控制器寄存器的IM字段写入将改变计时器计数结束后是否产生中断信号。
* 对控制器寄存器的Mode字段写入需要考虑当前计数情况
  * 若当前计数值大于0，即一个计数周期未结束，改变Mode的值将即时地改变计时器工作模式。
  * 若当前计数值为0，一个计数周期已结束，则改变Mode的值后的行为与当前工作模式有关。
    * 若当前工作于中断模式0，如果写入时计时器计数刚好到0，则可以切换到中断模式1，如果已经到0一段时间，则无法切换到工作模式1，且会导致中断信号一直开启，需要手动向Enable写入1才能进入中断模式1。
    * 若当前工作与中断模式1，则将会立即切换到中断模式0，但是如果当前计数值刚好为0，则需要等下一个计数周期结束才能按照中断模式0的行为停止计数。
    * 因此，由于对时钟周期的估算可能存在误差，不推荐在计数中途改变计时器的中断状态，这可能导致无法预料的后果。
* 对控制寄存器的Enable字段写入
  * 若原本的值是0，写入值是1，计时器将按照Mode的状态，IM的中断设置，载入初值寄存器的值开始计数。
  * 若原本的值是1，写入值是0，则将停止本计数周期，计时器进入待机模式，计数值寄存器保持当前值，直至下一次开始计数。